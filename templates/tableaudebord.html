<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Tableau de bord</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container py-5">
        <h2 class="mb-4 text-center text-primary">ğŸ“Š Tableau de bord - Odoo â‡„ Urcoopa</h2>

        <!-- SECTION ACTIONS -->
        <h3 class="mt-5 mb-3 text-center text-secondary">âš™ï¸ Actions disponibles</h3>
        <div class="row g-4">

            <!-- RÃ©cupÃ©ration des factures -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ“„ RÃ©cupÃ©ration des factures (Urcoopa)</h5>
                        <button id="btnFetchFactures" class="btn btn-primary">ğŸ”„ RÃ©cupÃ©rer</button>
                        <div id="statusFetchFactures" class="mt-3 text-muted fst-italic">En attente...</div>
                    </div>
                </div>
            </div>

            <!-- Injection des factures dans Odoo -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ“¦ Injection des factures dans Odoo</h5>
                        <button id="btnInjectFactures" class="btn btn-warning">âš¡ Injecter</button>
                        <div id="statusInjectFactures" class="mt-3 text-muted fst-italic">En attente...</div>
                    </div>
                </div>
            </div>

            <!-- Envoi des commandes vers Urcoopa -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ›’ Envoi des commandes Ã  Urcoopa</h5>
                        <button id="btnSendCommandes" class="btn btn-success">ğŸ“¤ Envoyer</button>
                        <div id="statusSendCommandes" class="mt-3 text-muted fst-italic">En attente...</div>
                    </div>
                </div>
            </div>

            <!-- Injection des factures adhÃ©rents -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ‘¨â€ğŸŒ¾ Injection des factures adhÃ©rents</h5>
                        <button id="btnInjectAdherents" class="btn btn-info">âš¡ Injecter</button>
                        <div id="statusInjectAdherents" class="mt-3 text-muted fst-italic">En attente...</div>
                    </div>
                </div>
            </div>

            <!-- Switch achats dropshipping rÃ©ceptionnÃ©s -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ“¦ Traitement achats dropshipping reÃ§us</h5>
                        <button id="btnDropshipping" class="btn btn-secondary">ğŸ”„ Traiter</button>
                        <div id="statusDropshipping" class="mt-3 text-muted fst-italic">En attente...</div>
                    </div>
                </div>
            </div>

        </div>


        <!-- SECTION INDICATEURS -->
        <div class="row g-4 mt-5">
            <!-- Commandes envoyÃ©es -->
            <h3 class="mt-5 mb-3 text-center text-secondary">ğŸ” Stats disponibles du mois</h3>
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ›’ Commandes envoyÃ©es Ã  l'urcoopa </h5>
                        <p class="display-5 text-success fw-bold">{{ stats.nb_commandes_odoo.commande }}</p>
                    </div>
                </div>
            </div>

            <!-- Factures rÃ©cupÃ©rÃ©es -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ“„ Factures rÃ©cupÃ©rÃ©es dâ€™Urcoopa</h5>
                        <p class="display-5 text-primary fw-bold">{{ stats.nb_factures_urcoopa[0] }}</p>
                    </div>
                </div>
            </div>

            <!-- Avoirs rÃ©cupÃ©rÃ©s -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ’¸ Avoirs rÃ©cupÃ©rÃ©s dâ€™Urcoopa</h5>
                        <p class="display-5 text-warning fw-bold">{{ stats.nb_avoirs_urcoopa.total_avoirs }}</p>
                    </div>
                </div>
            </div>

            <!-- Clients inconnus -->
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ‘¥ Clients inconnus</h5>
                        <p class="display-5 text-danger fw-bold">{{ stats.nb_clients_inconnus }}</p>
                    </div>
                </div>
            </div>

            <!-- Articles inconnus -->
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ“¦ Articles inconnus</h5>
                        <p class="display-5 text-danger fw-bold">{{ stats.nb_articles_inconnus }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-4">
            <!-- AdhÃ©rents Ã  intÃ©grer -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ‘¨â€ğŸŒ¾ AdhÃ©rents Ã  intÃ©grer (â‰  5000)</h5>
                        <p class="display-5 text-info fw-bold">{{ stats.nb_adherents_odoo.code_client }}</p>
                    </div>
                </div>
            </div>

            <!-- Clients vrac -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ§º Clients vrac (5000)</h5>
                        <p class="display-5 text-secondary fw-bold">{{ stats.nb_clients_vrac.code_client }}</p>
                    </div>
                </div>
            </div>

            <!-- Livraisons -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸšš Livraisons</h5>
                        <p class="display-5 text-success fw-bold">{{ stats.nb_livraisons.numero_bl }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DonnÃ©es comptables -->
        <div class="row g-4 mt-5">
            <div class="col-md-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ’° DonnÃ©es comptables</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>HT :</strong> {{ stats.donnees_comptables.ht | default("0") }} â‚¬</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>TVA :</strong> {{ stats.donnees_comptables.tva | default("0") }} â‚¬</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>TTC :</strong> {{ stats.donnees_comptables.ttc | default("0") }} â‚¬</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GOOGLE CHARTS -->
    <div class="row mt-5">
        <div class="col-md-12">
            <div id="chart_global" style="width:100%; height:450px;"></div>
        </div>
        <div class="col-md-6">
            <div id="chart_clients" style="width:100%; height:400px;"></div>
        </div>
        <div class="col-md-6">
            <div id="chart_livraisons" style="width:100%; height:400px;"></div>
        </div>
    </div>

    <!-- SCRIPT GOOGLE CHART -->
    <div id="chart_div2" style="width: 900px; height: 500px;"></div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {
            var data = google.visualization.arrayToDataTable([
                ['Generation', 'Descendants'],
                [0, 1], [1, 33], [2, 269], [3, 2013]
            ]);
            var options = {
                title: 'Descendants by Generation',
                hAxis: { title: 'Generation', minValue: 0, maxValue: 3 },
                vAxis: { title: 'Descendants', minValue: 0, maxValue: 2100 },
                trendlines: { 0: { type: 'exponential', visibleInLegend: true } }
            };
            var chart = new google.visualization.ScatterChart(document.getElementById('chart_div2'));
            chart.draw(data, options);
        }
    </script>

    <!-- SCRIPT ACTIONS -->
    <script>
        async function callApi(endpoint, method, statusId, messages) {
            const status = document.getElementById(statusId);
            status.innerHTML = messages.loading;
            status.className = "mt-3 text-warning fw-bold";

            try {
                let response = await fetch(endpoint, { method: method });
                if (response.ok) {
                    status.innerHTML = messages.success + " âœ…";
                    status.className = "mt-3 text-success fw-bold";
                } else {
                    status.innerHTML = messages.error + " âŒ";
                    status.className = "mt-3 text-danger fw-bold";
                }
            } catch (err) {
                status.innerHTML = "âš ï¸ API non joignable";
                status.className = "mt-3 text-danger fw-bold";
            }
        }

        // Assignation des boutons
        document.getElementById("btnUpdateFactures").addEventListener("click", () => {
            callApi("/api/update-factures", "GET", "statusUpdateFactures", {
                loading: "â³ Mise Ã  jour en cours...",
                success: "Factures mises Ã  jour",
                error: "Erreur pendant la mise Ã  jour"
            });
        });

        document.getElementById("btnTruncateClients").addEventListener("click", () => {
            callApi("/api/truncate-clients", "DELETE", "statusTruncateClients", {
                loading: "â³ Suppression en cours...",
                success: "Table clients vidÃ©e",
                error: "Erreur pendant la suppression"
            });
        });

        document.getElementById("btnVerify").addEventListener("click", () => {
            callApi("/api/verification-correspondance", "GET", "statusVerify", {
                loading: "â³ VÃ©rification en cours...",
                success: "VÃ©rification terminÃ©e",
                error: "Erreur pendant la vÃ©rification"
            });
        });

        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(drawCharts);

        function drawCharts() {

            // DonnÃ©es Python/Jinja injectÃ©es ici :
            const nbCommandes = {{ stats.nb_commandes_odoo.commande | default (0) }};
            const nbFactures = {{ stats.nb_factures_urcoopa[0] | default (0) }};
            const nbAvoirs = {{ stats.nb_avoirs_urcoopa.total_avoirs | default (0) }};
            const nbClientsInconnus = {{ stats.nb_clients_inconnus | default (0) }};
            const nbArticlesInconnus = {{ stats.nb_articles_inconnus | default (0) }};
            const nbAdherents = {{ stats.nb_adherents_odoo.code_client | default (0) }};
            const nbClientsVrac = {{ stats.nb_clients_vrac.code_client | default (0) }};
            const nbLivraisons = {{ stats.nb_livraisons.numero_bl | default (0) }};

            // 1ï¸âƒ£ Graphique global (barres)
            const dataGlobal = google.visualization.arrayToDataTable([
                ['Type', 'Nombre'],
                ['Commandes', nbCommandes],
                ['Factures', nbFactures],
                ['Avoirs', nbAvoirs]
            ]);

            const optionsGlobal = {
                title: 'Commandes, Factures et Avoirs',
                legend: { position: 'none' },
                colors: ['#28a745', '#007bff', '#ffc107'],
                chartArea: { width: '70%' },
            };

            new google.visualization.ColumnChart(document.getElementById('chart_global'))
                .draw(dataGlobal, optionsGlobal);

            // 2ï¸âƒ£ RÃ©partition des clients (secteurs)
            const dataClients = google.visualization.arrayToDataTable([
                ['CatÃ©gorie', 'Nombre'],
                ['AdhÃ©rents (<5000)', nbAdherents],
                ['Clients vrac (=5000)', nbClientsVrac],
                ['Inconnus', nbClientsInconnus]
            ]);

            const optionsClients = {
                title: 'RÃ©partition des clients',
                pieHole: 0.4,
                colors: ['#17a2b8', '#6c757d', '#dc3545']
            };

            new google.visualization.PieChart(document.getElementById('chart_clients'))
                .draw(dataClients, optionsClients);

            // 3ï¸âƒ£ Livraisons + Articles inconnus (comparatif)
            const dataLivraisons = google.visualization.arrayToDataTable([
                ['Type', 'Nombre'],
                ['Livraisons', nbLivraisons],
                ['Articles inconnus', nbArticlesInconnus]
            ]);

            const optionsLivraisons = {
                title: 'Livraisons & articles inconnus',
                colors: ['#28a745', '#dc3545'],
                legend: { position: 'bottom' }
            };

            new google.visualization.BarChart(document.getElementById('chart_livraisons'))
                .draw(dataLivraisons, optionsLivraisons);
        }
    </script>

</body>

</html>