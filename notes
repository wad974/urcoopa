# Configuration
$subnet = "172.17.2"  # Votre sous-r√©seau
$glpiServer = "http://172.17.240.10"  # Votre serveur GLPI
$username = "administrateur"  # Compte admin des postes
$password = "motdepasse"  # Mot de passe admin

# Cr√©ation des credentials
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)

# URL de t√©l√©chargement GLPI Agent
$glpiAgentUrl = "https://github.com/glpi-project/glpi-agent/releases/download/1.5/GLPI-Agent-1.5-x64.msi"

Write-Host "üîç Scan et d√©ploiement GLPI sur $subnet.1-255" -ForegroundColor Green

# Scanner et d√©ployer sur chaque IP
1..255 | ForEach-Object -Parallel {
    $ip = "$using:subnet.$_"
    $glpiServer = $using:glpiServer
    $credential = $using:credential
    $glpiAgentUrl = $using:glpiAgentUrl
    
    # Test de connectivit√©
    if (Test-Connection -ComputerName $ip -Count 1 -Quiet -TimeoutSeconds 2) {
        Write-Host "üì° $ip : Poste d√©tect√©, tentative d'installation..." -ForegroundColor Yellow
        
        try {
            # Script d'installation √† ex√©cuter sur le poste distant
            $installScript = {
                param($Server, $DownloadUrl)
                
                $tempPath = "$env:TEMP\glpi-agent.msi"
                
                try {
                    # T√©l√©charger GLPI Agent
                    Invoke-WebRequest -Uri $DownloadUrl -OutFile $tempPath -TimeoutSec 60
                    
                    # Installation silencieuse
                    $process = Start-Process msiexec.exe -ArgumentList "/i `"$tempPath`" /quiet SERVER=$Server SCAN-HOMEDIRS=1 SCAN-PROFILES=1" -Wait -PassThru
                    
                    # Nettoyer
                    Remove-Item $tempPath -Force -ErrorAction SilentlyContinue
                    
                    if ($process.ExitCode -eq 0) {
                        return "‚úÖ Installation r√©ussie"
                    } else {
                        return "‚ùå Erreur installation (code: $($process.ExitCode))"
                    }
                } catch {
                    return "‚ùå Erreur: $($_.Exception.Message)"
                }
            }
            
            # Ex√©cution sur le poste distant
            $result = Invoke-Command -ComputerName $ip -Credential $credential -ScriptBlock $installScript -ArgumentList $glpiServer, $glpiAgentUrl -ErrorAction Stop
            
            Write-Host "‚úÖ $ip : $result" -ForegroundColor Green
            
        } catch {
            Write-Host "‚ùå $ip : √âchec connexion - $($_.Exception.Message)" -ForegroundColor Red
        }
    }
    # Pas de message pour les IPs injoignables pour √©viter le spam
    
} -ThrottleLimit 20  # 20 connexions simultan√©es max

Write-Host "üèÅ D√©ploiement termin√© !" -ForegroundColor Green